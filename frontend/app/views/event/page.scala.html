@(event: model.Eventbrite.EBEvent, pageInfo: model.PageInfo)

@import views.support.Dates._
@import com.github.nscala_time.time.Imports._
@import org.joda.time.Instant
@import model.Eventbrite._
@import com.gu.membership.salesforce.Tier
@import configuration.Config

@ticketCta = {
    @event.getStatus match {
        case Live => {
            <a class='action js-ticket-cta' href='/event/@event.id/buy'>Buy tickets</a>
        }
        case nonLive => {
            <button class='action action--disabled js-ticket-cta' disabled='disabled'>
            @nonLive match {
                case Completed => { Past Event }
                case Cancelled => { Cancelled }
                case SoldOut => { Sold Out }
                case PreLive => { Coming Soon }
            }
            </button>
        }
    }
    <div class="terms-info">By proceeding, you agree to the<br /> Guardian Live events
        <a href="@Config.guardianLiveEventsTermsUrl" target="_blank">Terms and Conditions</a>
    </div>
}

@becomeMemberCta(ticket: EBTickets) = @{
    val ticketSaleDates = model.TicketSaleDates.datesFor(event.start, ticket)
    val friendSaleStartDate = ticketSaleDates.get(Tier.Friend).get

    if(friendSaleStartDate > Instant.now) {
        Html("<div><a class='action js-member-cta' href='/join'>Become a member</a></div>")
    }
}

@dateOrNow(tier: Tier.Tier, salesDate: Instant) = {
    <time class="js-ticket-sale-start-@tier.toString.toLowerCase" datetime="@salesDate">@salesDate.pretty</time>
}

@ticketBookingDates(ticket: EBTickets) = {
    @defining(model.TicketSaleDates.datesFor(event.start, ticket)) { ticketSaleDates =>
        
        @for((tier, salesDate) <- ticketSaleDates) {
            <ul class="ticket-info__list u-unstyled u-cf">
                <li class="ticket-info__item"><span class="ticket-info__item--left">@(tier + "s")</span> @dateOrNow(tier, salesDate)</li>
            </ul>
        }
    }
}

@main("Event Detail | " + event.name.text, pageInfo=pageInfo, containerPadding = false, isBrochure = true, htmlClass = "event") {
    <div class="event__content__header">
        <div class="event__content__container">
            <div class="event__masthead u-cf">
                <div class="event__title section-header page-header">events</div>
                <h1 class="event__name">@event.name.text</h1>
            </div>
        </div>
    </div>

    <div class="event__content__header event__content__header--shade">
        <div class="event__content__container event__content__container--details">
            <div class="event__details">
                <div class="event__time">@prettyDateWithTime(event.start)</div>
                <div class="event__location">
                    <span class="event__venue-name">@event.venue.name</span>
                    @if(event.addressOne) {
                        <span class="event__address">
                            , @event.eventAddressLine
                        </span>
                    }
                </div>
            </div>
            @if(event.isNoTicketEvent == false) {
                @for(ticket <- event.ticketClassesHead) {
                    <div class="event__tickets__wapper u-cf">
                        <div class="event__tickets">

                            @if(ticket.free) {
                                <div class="event__price">
                                    <span class="event__price-amount js-event-price">Free</span>
                                </div>
                            } else {
                                @for(pricing <- ticket.cost) {
                                    <div class="event__price">
                                        <span class="event__price-amount js-event-price">@pricing.formattedPrice</span>
                                    </div>
                                    <div class="event__trail">
                                        <span class="event__trail-tag js-event-price-tag">Partners/Patrons </span>
                                        <span class="event__trail-upsell js-event-price-discount">@pricing.discountPrice</span>
                                        <span class="event__trail-saving js-event-price-saving"> (save @pricing.savingPrice)</span>
                                    </div>
                                }
                            }
                        </div>
                        @ticketCta
                    </div>
                }
            }
            <div class="header-bar__guardian-live-logo">
                <i class="icon-sprite icon-sprite-guardian-live icon-sprite--resize-live-logo"></i>
            </div>
        </div>
        
    </div>

    
    <div class="event__content">
        
        <div class="event__image">
            <div class="delayed-image-load" data-src="@Config.eventImageUrlPath(event.id)/{width}{pixel_ratio}.jpg" data-alt="Please upload an event image" data-class="responsive-img"></div>
        </div>

        <div class="event__content-wapper u-cf">

            <div class="event__picture-byline">
                <p><i class="icon-sprite icon-sprite-caption-camera icon-sprite--margin-right"></i>Picture byline here picture byline here</p>
            </div>

            <div class="event__content-body">
                <div class="event__description">@Html(event.description.getOrElse(EBRichText("foobar", "foobarhtml")).cleanHtml)</div>
                <div class="event__social">
                    <div class="event__social-header">Share this</div>
                    <ul class="social u-unstyled u-cf" data-component="social" data-link-name="social">
                        <li class="social__item" data-link-name="email">
                            <a class="social__action social-icon-wrapper" data-link-name="top" href="#">
                            <span class="u-h">Share via Email</span>
                            <span class="social-icon">
                                <i class="icon-sprite icon-sprite-share-email"></i>
                            </span>
                            </a>
                        </li>
                        <li class="social__item" data-link-name="facebook">
                            <a class="social__action social-icon-wrapper" data-link-name="top" href="#">
                            <span class="u-h">Share on Facebook</span>
                            <span class="social-icon">
                                <i class="icon-sprite icon-sprite-share-facebook"></i>
                            </span>
                            </a>
                        </li>
                        <li class="social__item" data-link-name="twitter">
                            <a class="social__action social-icon-wrapper" data-link-name="top" href="#">
                            <span class="u-h">Share on Twitter</span>
                            <span class="social-icon">
                                <i class="icon-sprite icon-sprite-share-twitter"></i>
                            </span>
                            </a>
                        </li>
                        <li class="social__item" data-link-name="gplus">
                            <a class="social__action social-icon-wrapper" data-link-name="top" href="#">
                            <span class="u-h">Share on Google+</span>
                            <span class="social-icon">
                                <i class="icon-sprite icon-sprite-share-gplus"></i>
                            </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="event-info">

                <div class="event-info__name">@event.name.text</div>
                <div class="event-info__time event-info--line-divider"><i class="icon-sprite icon-sprite-large-early_booking icon-sprite--small"></i>@prettyDateWithTime(event.start)</div>
                <div class="event-info__location event-info--line-divider">
                    <span class="event-info__venue-name"><i class="icon-sprite icon-sprite-location icon-sprite--small"></i>@event.venue.name</span>@if(event.addressOne){, 
                    <span class="event-info__address">@event.eventAddressLine</span>
                    }

                </div>

                @if(event.isNoTicketEvent == false) {
                
                    @for(ticket <- event.ticketClassesHead) {

                        <div class="event-info__tickets event-info--line-divider">

                            <div class="ticket-info">
                                <div class="ticket-info__header"><i class="icon-sprite icon-sprite-book_tickets icon-sprite--small"></i>Ticket sales</div>
                                @ticketBookingDates(ticket)
                            </div>

                            <div class="event-info__sale-ends">
                                <span class="js-datetime-enhance-note"><strong>Sales @if(event.getStatus == Completed){ended on}else{end on}</strong></span>
                                <time class="js-datetime-enhance-time" datetime="@event.ticketClassesHead.head.sales_end.getOrElse("")">
                                 @event.ticketClassesHead.flatMap(_.sales_end).fold("")(_.prettyWithTime)
                                </time>
                            </div>

                            @if(ticket.free) {
                                <div class="event-info__price event-info--line-divider">
                                    <span class="event-info__price-amount js-event-price">Free</span>
                                </div>
                            } else {
                                @for(pricing <- ticket.cost) {
                                    <div class="event-info__price event-info--line-divider">
                                        <span class="event-info__price-amount js-event-price">@pricing.formattedPrice</span>
                                    </div>
                                    <div class="event-info__trail">
                                        <span class="event__trail-tag js-event-price-tag">Partners/Patrons </span>
                                        <span class="event__trail-upsell js-event-price-discount">@pricing.discountPrice</span>
                                        <span class="event__trail-saving js-event-price-saving"> (save @pricing.savingPrice)</span>
                                    </div>
                                }
                            }
                            @ticketCta
                            @becomeMemberCta(ticket)
                        </div>
                    }
                }
            </div>
        </div>
    </div>
  
}
