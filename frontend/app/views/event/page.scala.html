@(event: model.Eventbrite.EBEvent, pageInfo: model.PageInfo)

@import views.support.Dates._
@import org.joda.time.Instant
@import model.Eventbrite._
@import model.Eventbrite.EBEventStatus._
@import com.gu.membership.salesforce.Tier
@import configuration.Config

@ticketCta = {
    @event.getStatus match {
        case Completed => { <button class='action action--disabled js-ticket-cta' disabled='disabled'>Past Event</button> }
        case SoldOut => { <button class='action action--disabled js-ticket-cta' disabled='disabled'>Sold Out</button> }
        case Cancelled => { <button class='action action--disabled js-ticket-cta' disabled='disabled'>Cancelled</button> }
        case PreLive => { <button class='action action--disabled js-ticket-cta' disabled='disabled'>Buy Tickets</button> }
        case _ => { <a class='action js-ticket-cta' href='/event/@event.id/buy'>Buy Tickets</a> }
    }
}

@dateOrNow(tier: Tier.Tier, salesDate: Instant) = {
    <time class="js-ticket-sale-start-@tier.toString.toLowerCase" datetime="@salesDate">@salesDate.pretty</time>
}

@ticketBookingDates(ticket: EBTickets) = {
    @defining(model.TicketSaleDates.datesFor(event.start, ticket)) { ticketSaleDates =>
        <div class="tooltip__detail u-h js-booking-dates">
            <h2>Booking Dates</h2>
            @for((tier, salesDate) <- ticketSaleDates) {
                <p class="ticket-info">@(tier + "s") @dateOrNow(tier, salesDate)</p>
            }
            <p class="ticket-info">General Booking @dateOrNow(Tier.Friend, ticketSaleDates(Tier.Friend))</p>
            <div class="tooltip__stem"></div>
        </div>
    }
}

@main("Event Detail | " + event.name.text, pageInfo=pageInfo) {

    <div class="event">
        <div class="event__content">
            <div class="event__image">
                <div class="delayed-image-load" data-src="@Config.eventImageUrlPath(event.id)/{width}{pixel_ratio}.jpg" data-alt="Please upload an event image"></div>
            </div>
            <div class="event__content__inner">
                <div class="event__content-body">
                    <div class="event__masthead">
                        <h1 class="event__name section-header page-header">@event.name.text</h1>
                    </div>
                </div>
            </div>
            <div class="event__content__inner event__content__inner--sub">
                <div class="event__content-body">
                    <div class="event__meta">
                        <div class="event__time">@prettyDateWithTime(event.start)</div>
                        <div class="event__location">
                            <span class="event__venue-name">@event.venue.name</span>,
                            <span class="event__address">
                                @if(!event.addressOne.isEmpty){ <span>@event.addressOne</span>, }
                                @if(!event.addressTwo.isEmpty){ <span>@event.addressTwo</span>, }
                                @if(!event.city.isEmpty){ <span>@event.city</span>, }
                                @if(!event.region.isEmpty){ <span>@event.region</span>, }
                                @if(!event.countryName.isEmpty){ <span>@event.countryName</span> }
                                @if(!event.postal_code.isEmpty){ <span>@event.postal_code</span> }
                            </span>
                        </div>
                    </div>

                    @for(ticket <- event.ticketClassesHead) {

                        <div class="event__tickets">

                            @if(ticket.free) {
                                <div class="event__price">
                                    <span class="event__price-amount js-event-price">Free</span>
                                </div>
                            } else {
                                @for(pricing <- ticket.cost) {
                                    <div class="event__price">
                                        <span class="event__price-amount js-event-price">@pricing.formattedPrice</span>
                                        <span class="event__price-note js-event-price-note"> per ticket</span>
                                    </div>
                                    <div class="event__trail">
                                        <span class="event__trail-tag js-event-price-tag">Partners/Patrons </span>
                                        <span class="event__trail-upsell js-event-price-discount">@pricing.discountPrice</span>
                                        <span class="event__trail-saving js-event-price-saving"> (save @pricing.savingPrice)</span>
                                    </div>
                                }
                            }
                        <p class="terms-info">By proceeding, you agree to the Guardian Live events <a href="@Config.guardianLiveEventsTermsUrl" target="_blank">Terms and Conditions</a></p>
                            @ticketCta
                            <div class="ticket-info">
                                <p>General release <strong><time class="js-ticket-sale-start" datetime="@event.ticketClassesHead.flatMap(_.sales_start).getOrElse("")">
                                    @model.TicketSaleDates.datesFor(event.start, ticket)(Tier.Friend).pretty</time></strong>
                                </p>
                                <div>Pre-sale tickets available<span class="js-ticket-on-sale-now"></span>.
                                    <span class="booking-dates">Booking Dates
                                        <span class="tooltip"><i class="tooltip__cta">i</i>@ticketBookingDates(ticket)</span>
                                    </span>
                                </div>
                                <div class="ticket-info">
                                    <p class="u-h">Existing members
                                        <strong>
                                            <a class="js-ticket-sale-sign-in" href="@Config.idWebAppSigninUrl("")">sign in</a>
                                        </strong>
                                    </p>
                                </div>
                            </div>
                            <div>
                                <a class='action js-member-cta' href='/join'>Become a member</a>
                            </div>

                            <div class="event__sale-ends">
                                <span class="event__sale_ends_note js-datetime-enhance-note">Sales @if(event.getStatus == Completed){ended on}else{end on} </span>
                                <time class="event__sale_ends_time js-datetime-enhance-time" datetime="@event.ticketClassesHead.head.sales_end.getOrElse("")">
                                @event.ticketClassesHead.flatMap(_.sales_end).fold("")(_.prettyWithTime)</time>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="event__content-body">
                <div class="event__description">@Html(event.description.getOrElse(EBRichText("foobar", "foobarhtml")).cleanHtml)</div>
                @ticketCta
            </div>
        </div>
    </div>
}
